<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>跨域及解决方案 | -.-</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/blog/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="Lighting the way">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/blog/assets/css/0.styles.e84faf41.css" as="style"><link rel="preload" href="/blog/assets/js/app.b8aeef37.js" as="script"><link rel="preload" href="/blog/assets/js/2.a4763320.js" as="script"><link rel="preload" href="/blog/assets/js/3.45fe7a32.js" as="script"><link rel="preload" href="/blog/assets/js/14.40872037.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.e4c229c8.js"><link rel="prefetch" href="/blog/assets/js/11.51533447.js"><link rel="prefetch" href="/blog/assets/js/12.1d38907d.js"><link rel="prefetch" href="/blog/assets/js/13.30652a03.js"><link rel="prefetch" href="/blog/assets/js/15.946a591b.js"><link rel="prefetch" href="/blog/assets/js/16.d9f4083f.js"><link rel="prefetch" href="/blog/assets/js/17.361e5f30.js"><link rel="prefetch" href="/blog/assets/js/18.688ac5ef.js"><link rel="prefetch" href="/blog/assets/js/19.76e9f9f8.js"><link rel="prefetch" href="/blog/assets/js/20.9ff88979.js"><link rel="prefetch" href="/blog/assets/js/21.6d499bd4.js"><link rel="prefetch" href="/blog/assets/js/22.7c17c7f7.js"><link rel="prefetch" href="/blog/assets/js/23.fa76b240.js"><link rel="prefetch" href="/blog/assets/js/24.1c58c781.js"><link rel="prefetch" href="/blog/assets/js/25.ed1dd0f8.js"><link rel="prefetch" href="/blog/assets/js/26.5744df34.js"><link rel="prefetch" href="/blog/assets/js/27.3696bbc3.js"><link rel="prefetch" href="/blog/assets/js/28.f8e88c03.js"><link rel="prefetch" href="/blog/assets/js/29.1bfca1ba.js"><link rel="prefetch" href="/blog/assets/js/30.71b02f8c.js"><link rel="prefetch" href="/blog/assets/js/31.dd087d43.js"><link rel="prefetch" href="/blog/assets/js/32.36c5a973.js"><link rel="prefetch" href="/blog/assets/js/4.7de41e6b.js"><link rel="prefetch" href="/blog/assets/js/5.bcd139c2.js"><link rel="prefetch" href="/blog/assets/js/6.78e8350e.js"><link rel="prefetch" href="/blog/assets/js/7.c5c790ee.js"><link rel="prefetch" href="/blog/assets/js/8.9a483403.js"><link rel="prefetch" href="/blog/assets/js/9.0e65f52e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.e84faf41.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/assets/logo.png" alt="-.-" class="logo"> <span class="site-name can-hide">-.-</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/blog/categories/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Link" class="dropdown-title"><!----> <span class="title" style="display:;">Link</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://underglaze-blue.github.io/lodash-analysis/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Lodash  源码分析
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mozilla
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/Underglaze-Blue/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/blog/avatar.png"> <div class="blogger-info"><h3>江月何年初照人</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/blog/categories/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Link" class="dropdown-title"><!----> <span class="title" style="display:;">Link</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://underglaze-blue.github.io/lodash-analysis/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Lodash  源码分析
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://developer.mozilla.org/zh-CN/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mozilla
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/Underglaze-Blue/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS相关内容</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/pages/831fd5/" class="sidebar-link">从深拷贝看JS中的循环引用</a></li><li><a href="/blog/pages/956e0b/" class="sidebar-link">0.1+0.2 为什么不等于 0.3</a></li><li><a href="/blog/pages/e6bb41/" class="sidebar-link">JS中的位运算</a></li><li><a href="/blog/pages/24704b/" class="sidebar-link">稀疏数组与稠密数组</a></li><li><a href="/blog/pages/0ddb81/" class="sidebar-link">this到底指向谁</a></li><li><a href="/blog/pages/2db306/" class="sidebar-link">JS中的比较规范</a></li><li><a href="/blog/pages/4341c8/" class="sidebar-link">连续赋值</a></li><li><a href="/blog/pages/1de0d7/" aria-current="page" class="active sidebar-link">跨域及解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#什么是跨域" class="sidebar-link">什么是跨域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#同源策略会限制哪些内容" class="sidebar-link">同源策略会限制哪些内容？</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#在-dom-元素中存在以下标签-是允许跨域访问资源的" class="sidebar-link">在 DOM 元素中存在以下标签，是允许跨域访问资源的</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#针对于-ajax-请求的跨域问题" class="sidebar-link">针对于 Ajax 请求的跨域问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#跨域解决方案" class="sidebar-link">跨域解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#jsonp" class="sidebar-link">jsonp</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#cors" class="sidebar-link">CORS</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#postmessage" class="sidebar-link">postMessage</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#window-name-iframe" class="sidebar-link">window.name + iframe</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#location-hash-iframe" class="sidebar-link">location.hash + iframe</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#document-domain-iframe" class="sidebar-link">document.domain + iframe</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#websocket" class="sidebar-link">WebSocket</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#nginx-反向代理" class="sidebar-link">nginx 反向代理</a></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#node-中间件实现跨域" class="sidebar-link">node 中间件实现跨域</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/pages/1de0d7/#最后" class="sidebar-link">最后</a></li></ul></li><li><a href="/blog/pages/af9354/" class="sidebar-link">节流和防抖</a></li><li><a href="/blog/pages/b8c982/" class="sidebar-link">从输入 URL 到页面展示，这中间发生了什么？</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-583ea4e9><div class="articleInfo" data-v-583ea4e9><ul class="breadcrumbs" data-v-583ea4e9><li data-v-583ea4e9><a href="/blog/" title="首页" class="iconfont icon-home router-link-active" data-v-583ea4e9></a></li> <li data-v-583ea4e9><a href="/blog/categories/?category=js" title="分类" data-v-583ea4e9>js</a></li> <li data-v-583ea4e9><a href="/blog/categories/?category=JS%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9" title="分类" data-v-583ea4e9>JS相关内容</a></li> <!----></ul> <div class="info" data-v-583ea4e9><div title="作者" class="author iconfont icon-touxiang" data-v-583ea4e9><a href="https://github.com/Underglaze-Blue" target="_blank" title="作者" class="beLink" data-v-583ea4e9>江月何年初照人</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-583ea4e9><a href="javascript:;" data-v-583ea4e9>2021-03-23</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          跨域及解决方案
        </h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="跨域及解决方案"><a href="#跨域及解决方案" class="header-anchor">#</a> 跨域及解决方案</h1> <h2 id="什么是跨域"><a href="#什么是跨域" class="header-anchor">#</a> 什么是跨域</h2> <p>有跨域就会有同域，也就是我们常说的<a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">同源策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> , MDN 上对于同源策略的解释为</p> <div class="custom-block tip"><p class="custom-block-title">同源策略</p> <p>是一个重要的安全策略，它用于限制一个 origin 的文档或者它加载的脚本如何能与另一个源的资源进行交互。它能帮助阻隔恶意文档，减少可能被攻击的媒介。</p> <p>如果两个 URL 的 protocol、port (如果有指定的话) 和 host 都相同的话，则这两个 URL 是同源。这个方案也被称为 “协议 / 主机 / 端口元组”，或者直接是 “元组”。（“元组” 是指一组项目构成的整体，双重 / 三重 / 四重 / 五重 / 等的通用形式）。</p></div> <p>是什么意思呢，简单来说就是同源策略是一种约束，作用是为了安全性考虑，它用来防止一些例如 XSS、CSRF 等攻击。</p> <p>同源是指 <code>协议 + 域名 + 端口</code> 三者相同，子域名不同也认为不同源</p> <img src="/blog/assets/domain.jpg"> <h3 id="同源策略会限制哪些内容"><a href="#同源策略会限制哪些内容" class="header-anchor">#</a> 同源策略会限制哪些内容？</h3> <ol><li><code>LocalStorage</code> 、 <code>Cookie</code> 、 <code>IndexDB</code> 等存储相关，只能同域访问</li> <li><code>DOM</code> 元素也存在同源策略，例如 <code>&lt;iframe&gt;&lt;/iframe&gt;</code></li> <li><code>Ajax</code> 请求的返回结果，<code>Ajax</code> 跨域访问拦截的不是请求，是返回的结果，浏览器会认为不安全，会拦截</li></ol> <h3 id="在-dom-元素中存在以下标签-是允许跨域访问资源的"><a href="#在-dom-元素中存在以下标签-是允许跨域访问资源的" class="header-anchor">#</a> 在 DOM 元素中存在以下标签，是允许跨域访问资源的</h3> <ol><li><code>&lt;img src=&quot;https://www.baidu.com/test.png&quot; /&gt;</code></li> <li><code>&lt;link href=&quot;https://www.google.com/test.css&quot; /&gt;</code></li> <li><code>&lt;script src=&quot;https://www.google.com/test.js&quot;&gt;&lt;/script&gt;</code></li></ol> <h3 id="针对于-ajax-请求的跨域问题"><a href="#针对于-ajax-请求的跨域问题" class="header-anchor">#</a> 针对于 <code>Ajax</code> 请求的跨域问题</h3> <p><strong>跨域并不是请求发不出去，请求能发出去，服务端能收到请求并正常返回结果，只是结果被浏览器拦截了</strong>， 因为 <code>Ajax</code> 请求会读取返回内容，因此浏览器不允许你这么做（一个域名的 JS ，在未经允许的情况下，不得读取另一个域名的内容。但浏览器并不阻止你向另一个域名发送请求。）。但是 <code>form</code> 表单却不存在 跨域的问题，是因为 <code>form</code> 表单再提交后，并不能获取到返回的内容，所以浏览器认为这是安全的。</p> <p><code>Ajax</code> 和 <code>form</code> 表单提交，都可以携带 <code>cookie</code> ，所以 <code>form</code> 表单提交 和 <code>Ajax</code> 并不能阻止 <code>CSRF</code> 攻击，因为请求已经发出去了，通过 <code>cookie</code> 的新属性 <code>SameSite</code> 可以避免这个问题</p> <h2 id="跨域解决方案"><a href="#跨域解决方案" class="header-anchor">#</a> 跨域解决方案</h2> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> jsonp</h3> <h4 id="jsonp-原理"><a href="#jsonp-原理" class="header-anchor">#</a> jsonp 原理</h4> <p><code>JSONP</code> 的原理非常简单，就是利用 <code>HTML</code> 标签的 <code>src</code> 属性可以跨域访问资源的特性，通过 <code>script</code> 标签来执行跨域的 <code>JS</code> 代码，通过这些代码，来实现前端跨域请求数据</p> <h4 id="jsonp-的实现"><a href="#jsonp-的实现" class="header-anchor">#</a> jsonp 的实现</h4> <ol><li><p>首先声明一个回调函数，函数名当做参数，传递给跨域请求的服务器</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>创建一个 <code>script</code> 标签，<code>script</code> 标签的 <code>src</code> 为需要跨域请求的服务器地址，然后拼接回调函数参数，回调函数的名称按照约定来书写，以百度搜索举例</p> <p>我们在百度搜索时，百度搜索存在根据用户输入自动识别显示匹配列表，这个过程就是一个 <code>jsonp</code> 的请求过程</p> <p>在 <code>Network</code> 中，搜索不属于 <code>XHR</code> 请求，它是一个 <code>jsonp</code> 的请求，我们以搜索 <code>aab</code> 为例，得到搜索的地址如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>https://www.baidu.com/sugrec?pre=1&amp;p=3&amp;ie=utf-8&amp;json=1&amp;prod=pc&amp;from=pc_web&amp;sugsid=33358,33261,33344,31660,33692,33595,33759,33675,33714,26350&amp;wd=aab&amp;req=2&amp;csor=3&amp;pwd=a&amp;cb=jQuery110207690587662328763_1616507377096&amp;_=1616507377102
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里 <code>wd=aab</code> 是我们搜索的关键字，<code>cb=jQuery110207690587662328763_1616507377096</code> 则是 <code>jsonp</code> 的回调函数</p> <p>我们拿到关键的信息，简化 <code>jsonp</code> 地址，得到如下地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>https://www.baidu.com/sugrec?prod=pc&amp;wd=aab&amp;cb=callback
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>访问结果如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// https://www.baidu.com/sugrec?prod=pc&amp;wd=aab&amp;cb=show</span>

<span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aab&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;p&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;g&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sug&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s_1&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aabc式词语大全&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sug&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s_2&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aab式的词语&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sug&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s_3&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aabb式的词语&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sug&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s_7&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aabc式词语大全三年级下册&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sug&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s_8&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aabc式词语大全 成语二年级&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sug&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s_9&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aabc式词语四字&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sug&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s_10&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;q&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aabc成语四字&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;slid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7841404972524760491&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;queryid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0x644446e751edab&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>那么此时，我们可以创建一个 <code>script</code> 标签，配合第一步创建的函数，来实现 <code>jsonp</code> ，拿到返回的数据</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://www.baidu.com/sugrec?prod=pc&amp;wd=aab&amp;cb=callback<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div> <iframe height="303" scrolling="no" title="jsonp跨域" src="https://codepen.io/underglaze-blue/embed/GRrgNKq?height=303&amp;theme-id=dark&amp;default-tab=html,result" frameborder="no" loading="lazy" allowtransparency="true" allowfullscreen="allowfullscreen" style="width:100%;">
   See the Pen <a href="https://codepen.io/underglaze-blue/pen/GRrgNKq">jsonp跨域</a> by 雨娑
   (<a href="https://codepen.io/underglaze-blue">@underglaze-blue</a>) on <a href="https://codepen.io">CodePen</a>.
 </iframe></li> <li><p>至此就实现了一个简单的 <code>jsonp</code> 请求</p></li></ol> <h4 id="jsonp-的封装"><a href="#jsonp-的封装" class="header-anchor">#</a> jsonp 的封装</h4> <p>在日常开发中，如果每次都需要这么写，就显得很繁琐，我们可以根据实现思路，封装一个 <code>jsonp</code> 请求</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url<span class="token punctuation">,</span> params<span class="token punctuation">,</span> cb <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理参数拼接</span>
  <span class="token keyword">function</span> <span class="token function">handlerParams</span><span class="token punctuation">(</span><span class="token parameter">query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> k<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&amp;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 首先创建 script 标签</span>
    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
    <span class="token comment">// 2. 创建一个挂载到 window 上的函数，方便访问，在函数里将数据抛出去，然后降创建的 script 标签删除掉</span>
    window<span class="token punctuation">[</span>cb<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3. 将回调函数名拼接到最后</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>params<span class="token punctuation">,</span> cb<span class="token punctuation">}</span>
    <span class="token comment">// 4. 处理参数后拼接url</span>
    script<span class="token punctuation">.</span>src <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token function">handlerParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

    <span class="token comment">// 5. 将 script 标签添加到 body 中</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><iframe height="265" scrolling="no" title="jsonp跨域封装" src="https://codepen.io/underglaze-blue/embed/gOgbmYJ?height=265&amp;theme-id=dark&amp;default-tab=html,result" frameborder="no" loading="lazy" allowtransparency="true" allowfullscreen="allowfullscreen" style="width:100%;">
  See the Pen <a href="https://codepen.io/underglaze-blue/pen/gOgbmYJ">jsonp跨域封装</a> by 雨娑
  (<a href="https://codepen.io/underglaze-blue">@underglaze-blue</a>) on <a href="https://codepen.io">CodePen</a>.
</iframe> <h4 id="其他-jsonp-的实现"><a href="#其他-jsonp-的实现" class="header-anchor">#</a> 其他 jsonp 的实现</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * Module dependencies
 */</span>

<span class="token keyword">var</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'jsonp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Module exports.
 */</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> jsonp<span class="token punctuation">;</span>

<span class="token comment">/**
 * Callback index.
 */</span>

<span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Noop function.
 */</span>

<span class="token keyword">function</span> <span class="token function">noop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/**
 * JSONP handler
 *
 * Options:
 *  - param {String} qs parameter (`callback`)
 *  - prefix {String} qs parameter (`__jp`)
 *  - name {String} qs parameter (`prefix` + incr)
 *  - timeout {Number} how long after a timeout error is emitted (`60000`)
 *
 * @param {String} url
 * @param {Object|Function} optional options / callback
 * @param {Function} optional callback
 */</span>

<span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'function'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">=</span> opts<span class="token punctuation">;</span>
    opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>opts<span class="token punctuation">)</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> prefix <span class="token operator">=</span> opts<span class="token punctuation">.</span>prefix <span class="token operator">||</span> <span class="token string">'__jp'</span><span class="token punctuation">;</span>

  <span class="token comment">// use the callback name that was passed if one was provided.</span>
  <span class="token comment">// otherwise generate a unique name by incrementing our counter.</span>
  <span class="token keyword">var</span> id <span class="token operator">=</span> opts<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> param <span class="token operator">=</span> opts<span class="token punctuation">.</span>param <span class="token operator">||</span> <span class="token string">'callback'</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token operator">!=</span> opts<span class="token punctuation">.</span>timeout <span class="token operator">?</span> opts<span class="token punctuation">.</span>timeout <span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> enc <span class="token operator">=</span> encodeURIComponent<span class="token punctuation">;</span>
  <span class="token keyword">var</span> target <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> document<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
  <span class="token keyword">var</span> script<span class="token punctuation">;</span>
  <span class="token keyword">var</span> timer<span class="token punctuation">;</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Timeout'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>script<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span> script<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> noop<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  window<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'jsonp got'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// add qs component</span>
  url <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token operator">~</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'&amp;'</span> <span class="token operator">:</span> <span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">+</span> param <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">enc</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'?&amp;'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'jsonp req &quot;%s&quot;'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// create script</span>
  script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  script<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> cancel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h4 id="jsonp-限制"><a href="#jsonp-限制" class="header-anchor">#</a> jsonp 限制</h4> <p>jsonp 只支持 get 请求，对于其他请求不支持。优点是兼容性好。</p> <h3 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h3> <h4 id="cors-是什么"><a href="#cors-是什么" class="header-anchor">#</a> <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">CORS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是什么</h4> <div class="custom-block tip"><p class="custom-block-title">CORS</p> <p>跨源资源共享 (CORS) （或通俗地译为跨域资源共享）是一种基于 HTTP 头的机制，该机制通过允许服务器标示除了它自己以外的其它 origin（域，协议和端口），这样浏览器可以访问加载这些资源。跨源资源共享还通过一种机制来检查服务器是否会允许要发送的真实请求，该机制通过浏览器发起一个到服务器托管的跨源资源的 &quot;预检&quot; 请求。在预检中，浏览器发送的头中标示有 HTTP 方法和真实请求中会用到的头。</p></div> <div class="custom-block tip"><p class="custom-block-title">原理</p> <p>跨源资源共享标准新增了一组 HTTP 首部字段，允许服务器声明哪些源站通过浏览器有权限访问哪些资源。另外，规范要求，对那些可能对服务器数据产生副作用的 HTTP 请求方法（特别是 GET 以外的 HTTP 请求，或者搭配某些 MIME 类型的 POST 请求），浏览器必须首先使用 OPTIONS 方法发起一个预检请求（preflight request），从而获知服务端是否允许该跨源请求。服务器确认允许之后，才发起实际的 HTTP 请求。在预检请求的返回中，服务器端也可以通知客户端，是否需要携带身份凭证（包括 Cookies 和 HTTP 认证相关数据）。</p> <p>CORS 请求失败会产生错误，但是为了安全，在 JavaScript 代码层面是无法获知到底具体是哪里出了问题。你只能查看浏览器的控制台以得知具体是哪里出现了错误。</p></div> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>IE 10 提供了对规范的完整支持，但在较早版本（8 和 9）中，CORS 机制是借由 XDomainRequest 对象完成的</p></div> <h4 id="cors-发送请求的情况"><a href="#cors-发送请求的情况" class="header-anchor">#</a> CORS 发送请求的情况</h4> <ol><li><p>不会触发 CORS 预检的请求，也就是简单请求，若请求满足所有下述条件，则该请求可视为 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82" target="_blank" rel="noopener noreferrer">简单请求<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ：</p> <ul><li>使用下列方法之一
<ul><li><code>GET</code></li> <li><code>HEAD</code></li> <li><code>POST</code></li></ul></li> <li><code>Content-Type</code> 的值仅限于下列三者之一
<ul><li><code>text/plain</code></li> <li><code>multipart/form-data</code></li> <li><code>application/x-www-form-urlencoded</code></li></ul></li> <li>请求中的任意 <code>XMLHttpRequestUpload</code> 对象均没有注册任何事件监听器；<code>XMLHttpRequestUpload</code> 对象可以使用 <code>XMLHttpRequest.upload</code> 属性访问</li></ul> <p>还有其他情况可参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82" target="_blank" rel="noopener noreferrer">简单请求<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ， 这里列出了一些比较常用的</p></li> <li><p>会触发 CORS 预检的请求</p> <p>不符合简单请求的情况下，会触发。需预检的请求 要求必须首先使用 <code>OPTIONS</code> 方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求。 预检请求 的使用，可以避免跨域请求对服务器的用户数据产生未预期的影响。</p> <p><code>OPTIONS</code> 是 <code>HTTP/1.1</code> 协议中定义的方法，用以从服务器获取更多信息。该方法不会对服务器资源产生影响。 预检请求中同时携带了下面两个首部字段</p> <div class="language-http request line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Access-Control-Request-Method:</span> POST
<span class="token header-name keyword">Access-Control-Request-Headers:</span> X-PINGOTHER, Content-Type
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>首部字段 <code>Access-Control-Request-Method</code> 告知服务器，实际请求将使用 <code>POST</code> 方法。首部字段 <code>Access-Control-Request-Headers</code> 告知服务器，实际请求将携带两个自定义请求首部字段：<code>X-PINGOTHER</code> 与 <code>Content-Type</code>。服务器据此决定，该实际请求是否被允许。</p></li> <li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS#http_%E5%93%8D%E5%BA%94%E9%A6%96%E9%83%A8%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">HTTP 响应首部字段<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，也就是 <code>CORS</code> 的根本，这些字段是 服务器响应时，需要配置的字段及值，分别如下</p> <ul><li><code>Access-Control-Allow-Origin</code> ， origin 参数的值指定了允许访问该资源的外域 URI。对于不需要携带身份凭证的请求，服务器可以指定该字段的值为通配符，表示允许来自所有域的请求<div class="language-http request line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Access-Control-Allow-Origin:</span> &lt;origin&gt; | *
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><code>Access-Control-Expose-Headers</code> 头让服务器把允许浏览器访问的头放入白名单<div class="language-http request line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Access-Control-Expose-Headers:</span> X-My-Custom-Header, X-Another-Custom-Header
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><code>Access-Control-Max-Age</code> 头指定了 预检 请求的结果能够被缓存多久，delta-seconds 参数表示 预检 请求的结果在多少秒内有效<div class="language-http request line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Access-Control-Max-Age:</span> &lt;delta-seconds&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><code>Access-Control-Allow-Credentials</code> 头指定了当浏览器的 credentials 设置为 true 时是否允许浏览器读取 response 的内容。 也就是在请求是携带 cookie 凭证。在请求携带 <code>cookie</code> 时，有一点需要注意，如果服务器端 <code>Access-Control-Allow-Origin</code> 设置为通配符 <code>*</code>，请求将会失败。<div class="language-http request line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Access-Control-Allow-Credentials:</span> true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><code>Access-Control-Allow-Methods</code> 首部字段用于预检请求的响应。其指明了实际请求所允许使用的 HTTP 方法。<div class="language-http request line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Access-Control-Allow-Methods:</span> &lt;method&gt;[, &lt;method&gt;]*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><code>Access-Control-Allow-Headers</code> 首部字段用于预检请求的响应。其指明了实际请求中允许携带的首部字段。<div class="language-http request line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Access-Control-Allow-Headers:</span> &lt;field-name&gt;[, &lt;field-name&gt;]*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <p><strong>后端设置响应的 <code>HTTP</code> 响应头是 <code>CORS</code> 实现的关键</strong></p> <p>相关示例可查看 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">MDN 中对于 CORS 的说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol> <h3 id="postmessage"><a href="#postmessage" class="header-anchor">#</a> <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage" target="_blank" rel="noopener noreferrer">postMessage<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <h4 id="postmessage-是什么"><a href="#postmessage-是什么" class="header-anchor">#</a> postMessage 是什么</h4> <div class="custom-block tip"><p class="custom-block-title">postMessage</p> <p>postMessage 是 html5 引入的 API,postMessage () 方法允许来自不同源的脚本采用异步方式进行有效的通信，可以实现跨文本文档，多窗口，跨域消息传递。多用于窗口间数据通信，这也使它成为跨域通信的一种有效的解决方案.</p></div> <p><code>window.postMessage()</code> 方法可以安全地实现跨源通信。</p> <div class="language-textmate line-numbers-mode"><pre class="language-text"><code>otherWindow.postMessage(message, targetOrigin, [transfer]);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><code>otherWindow</code> 其他窗口的一个引用，比如 iframe 的 contentWindow 属性、执行 window.open 返回的窗口对象、或者是命名过或数值索引的 window.frames。</li> <li><code>message</code> 将要发送到其他 window 的数据。</li> <li><code>targetOrigin</code> 通过窗口的 origin 属性来指定哪些窗口能接收到消息事件，其值可以是字符串 <code>*</code>（表示无限制）或者一个 <code>URI</code>。*<em>如果你明确的知道消息应该发送到哪个窗口，那么请始终提供一个有确切值的 targetOrigin，而不是 <em>。不提供确切的目标将导致数据泄露到任何对数据感兴趣的恶意站点</em></em></li> <li><code>transfer</code> 可选。是一串和 <code>message</code> 同时传递的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Transferable" target="_blank" rel="noopener noreferrer">Transferable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对象。这些对象的所有权将被转移给消息的接收方，而发送一方将不再保有所有权。</li></ul> <h4 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h4> <p>从 <code>a.html</code> 向 <code>iframe</code> 的 <code>b.html</code> 发送消息</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- a.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://localhost:8899/b.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>frame<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>load()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> frame <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'frame'</span><span class="token punctuation">)</span>
        frame<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'from a'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:8000/a.html'</span><span class="token punctuation">)</span> <span class="token comment">// 发送数据</span>
        window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 接收数据</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// from b</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--b.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 接收数据</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// from a</span>
      e<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'from b'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>origin<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>message</code> 属性具有：</p> <ul><li><code>data</code> 从其他 <code>window</code> 中传递过来的对象</li> <li><code>origin</code> 调用 <code>postMessage</code>  时消息发送方窗口的 <code>origin</code></li> <li><code>source</code> 对发送消息的窗口对象的引用</li></ul> <h3 id="window-name-iframe"><a href="#window-name-iframe" class="header-anchor">#</a> window.name + iframe</h3> <div class="custom-block tip"><p class="custom-block-title">window.name</p> <p>window.name 有一个性质， 页面如果设置了 window.name，那么在不关闭页面的情况下，即使进行了页面跳转，这个 window.name 还是会保留</p></div> <p>根据 window.name 的这个性质，我们可以实现 跨域访问数据</p> <p>假设我们需要从 <code>a.html</code> 拿到 <code>c.html</code> 中的数据，那么我们可以找一个和 <code>a.html</code> 同源的页面 <code>b.html</code>，也就是说</p> <ul><li>a 和 b 是同源的</li> <li>a 要拿到 c 的数据</li></ul> <p>实现就是 <strong>a 先引用 c，然后 c 设置 window.name ，然后 把 a 的引用地址改为 b</strong></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--a.html--&gt;</span>
<span class="token comment">&lt;!--http://localhost:8000/a.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://localhost:8899/c.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>iframe<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>load<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token boolean">true</span>
   <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:8000/b.html'</span>
         type <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// from c</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--c.html--&gt;</span>
<span class="token comment">&lt;!--http://localhost:8899/c.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   window<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'from c'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>以 <code>b.html</code> 作为中间页，监听 <code>iframe</code> 第二次的 <code>onload</code> 事件，就可以拿到想要的数据</p> <h3 id="location-hash-iframe"><a href="#location-hash-iframe" class="header-anchor">#</a> location.hash + iframe</h3> <p>这个办法比较绕，但是可以解决完全跨域情况下的脚步置换问题。原理是利用 <code>location.hash</code> 来进行传值。</p> <div class="custom-block tip"><p class="custom-block-title">hash</p> <p><code>http://www.google.com#abc</code> 中的 <code>#abc</code> 就是 <code>location.hash</code> ， 改变 <code>location.hash</code> 并不会导致页面刷新，所以可以通过 <code>location.hash</code> 来传递数据，当然容量是有限的</p></div> <h4 id="实现过程"><a href="#实现过程" class="header-anchor">#</a> 实现过程</h4> <p>假设，同样有两个页面 a 、 c， a 要和 c 通信</p> <p>第一步，a 先引用 c</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--a.html--&gt;</span>
<span class="token comment">&lt;!--http://localhost:8000/a.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://localhost:8899/c.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在引用时，可以通过 location.hash 传值，也就是</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--a.html--&gt;</span>
<span class="token comment">&lt;!--http://localhost:8000/a.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://localhost:8899/c.html#abc<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第二步，在 c 里面接收传入的 hash，并且传递数据给 a 的同源页面 b</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--c.html--&gt;</span>
<span class="token comment">&lt;!--http://localhost:8899/c.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token comment">// abc</span>
   <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span>
   iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8000/b.html#c2a&quot;</span>
   document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>第三步，在 b 页面中，将 hash 传递给 a ，因为 b 和 a 是同源，所以可以传递信息</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--b.html--&gt;</span>
<span class="token comment">&lt;!--http://localhost:8000/b.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> location<span class="token punctuation">.</span>hash <span class="token comment">// b 传递信息给 a， b 的父级是 c ，c 的父级是 a， b 和 a 是同源</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第四步，在 a 里面进行监听，然后处理逻辑</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--a.html--&gt;</span>
<span class="token comment">&lt;!--http://localhost:8000/a.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://localhost:8899/c.html#abc<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   window<span class="token punctuation">.</span><span class="token function-variable function">onhashchange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token comment">// c2a</span>
   <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这样也就实现了 跨域传递数据</p> <h3 id="document-domain-iframe"><a href="#document-domain-iframe" class="header-anchor">#</a> document.domain + iframe</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>该方式只能用于主域名相同的情况下，比如 <code>https://a.google.com</code> 和 <code>https://b.google.com</code></p></div> <h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h4> <p>原理就是通过设置 <code>document.domain</code> 使得 a 和 b 属于同源，绕过浏览器的检查</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>端口号是由浏览器另行检查的。任何对 document.domain 的赋值操作，包括 document.domain = document.domain 都会导致端口号被重写为 null 。因此 company.com:8080 不能仅通过设置 document.domain = &quot;company.com&quot; 来与 company.com 通信。必须在他们双方中都进行赋值，以确保端口号都为 null 。</p></div> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>使用 document.domain 来允许子域安全访问其父域时，您需要在父域和子域中设置 document.domain 为相同的值。这是必要的，即使这样做只是将父域设置回其原始值。不这样做可能会导致权限错误。</p></div> <h4 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h4> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--a.html--&gt;</span>
<span class="token comment">&lt;!--http://a.test.com:8080/a.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://b.test.com:8080/b.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>load<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>iframe<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">'test.com'</span>
   <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>temp<span class="token punctuation">)</span> <span class="token comment">// b</span>
   <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--b.html--&gt;</span>
<span class="token comment">&lt;!--http://b.test.com:8080/b.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">'test.com'</span>
   <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token string">'b'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>也就是通过设置 document.domain 实现了 跨域通信</p> <h3 id="websocket"><a href="#websocket" class="header-anchor">#</a> <a href="https://www.runoob.com/html/html5-websocket.html" target="_blank" rel="noopener noreferrer">WebSocket<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议，WebSocket 本身不存在同源策略限制，所以可以实现跨域。WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p></div> <h4 id="实现思路"><a href="#实现思路" class="header-anchor">#</a> 实现思路</h4> <p>在建立 <code>WebSocket</code> 连接后，你可以通过 <code>send()</code> 方法来向服务器发送数据，并通过 <code>onmessage</code> 事件来接收服务器返回的数据。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--客户端--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   <span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:8080'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'客户端'</span><span class="token punctuation">)</span> <span class="token comment">// 向服务器发送数据</span>
   <span class="token punctuation">}</span>
   socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// 接收服务器返回的数据</span>
   <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 服务端，使用 node.js 模拟</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token operator">:</span> <span class="token number">8080</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'服务端'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>使用 <code>WebSocket</code> 同样也可以实现跨域</p> <h3 id="nginx-反向代理"><a href="#nginx-反向代理" class="header-anchor">#</a> nginx 反向代理</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>使用 nginx 反向代理实现跨域，只需要修改 nginx 的配置即可解决跨域问题。</p> <p>a 网站向 b 网站请求某个接口时，向 b 网站发送一个请求，nginx 根据配置文件接收这个请求，代替 a 网站向 b 网站来请求。
nginx 拿到这个资源后再返回给 a 网站，以此来解决了跨域问题。</p></div> <h4 id="实现-2"><a href="#实现-2" class="header-anchor">#</a> 实现</h4> <p>配置 nginx，监听本地 8080 端口，将 /api 请求转发到 localhost:9000</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># nginx.conf</span>
server <span class="token punctuation">{</span>
    listen       <span class="token number">8080</span><span class="token punctuation">;</span>
    server_name  localhost<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
        root   html<span class="token punctuation">;</span>
        index  index.html index.htm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    location /api <span class="token punctuation">{</span>
        proxy_pass http://localhost:9000<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/getData'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'a'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
   res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在 <code>http://localhost:8080</code> 的 <code>index</code> 页面中，使用 <code>ajax</code> 去请求  <code>/api/getData</code> , 会得到 <code>JSON</code> 数据</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;a&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;b&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样也就实现了跨域</p> <h4 id="nginx-常用命令"><a href="#nginx-常用命令" class="header-anchor">#</a> nginx 常用命令</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>nginx -s reload     <span class="token comment"># 优雅重启，并重新载入配置文件nginx.conf</span>

nginx -s quit       <span class="token comment">#  优雅停止nginx，有连接时会等连接请求完成再杀死worker进程 </span>

nginx -s reopen     <span class="token comment"># 重新打开日志文件，一般用于切割日志</span>

nginx -v            <span class="token comment"># 查看版本  </span>

nginx -t            <span class="token comment"># 检查nginx的配置文件</span>

nginx -h            <span class="token comment"># 查看帮助信息</span>

nginx  -c filename  <span class="token comment"># 指定配置文件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="文档"><a href="#文档" class="header-anchor">#</a> 文档</h4> <p><a href="https://juejin.cn/post/6844904129987526663" target="_blank" rel="noopener noreferrer">连前端都看得懂的《Nginx 入门指南》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="node-中间件实现跨域"><a href="#node-中间件实现跨域" class="header-anchor">#</a> node 中间件实现跨域</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>跨域问题是浏览器的同源策略的安全机制引起的，服务器之间是不存在跨域问题的，这也不是说服务器之间没有安全机制，只是服务器之间的调用无论是通过 http 访问还是通过 rpc 调用都是协议层面的机制，并没有限制必须同源。</strong> 这也就是 Node 层跨域的实质，我们把静态文件和 Node 中间层放在同一个域下，这样前端资源和 Node 层的通信不会受同源策略影响，然后我们通过 Node 中间层把前端的资源请求转发到真实的请求地址，在通过中间层把请求返回的数据传给前端，这样就实现了此域跨彼域的串门操作。</p></div> <h4 id="实现-3"><a href="#实现-3" class="header-anchor">#</a> 实现</h4> <p>本地的 <code>http://localhost:3000/a.html</code> 页面需要请求 <code>http://localhost:9001</code> 的数据，但是 <code>9001</code> 的服务端又不能使用 <code>CORS</code> 的方式来实现跨域，我们可以使用 <code>node</code> 实现一个中间件，达到跨域的效果</p> <p>第一步，创建一个请求，不请求 9001， 请求 4000</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--客户端--&gt;</span>
<span class="token comment">&lt;!--http://localhost:3000/a.html--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:4000/api/getData'</span><span class="token punctuation">)</span>
   xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>第二步，实现 node 中间件代理转发，以下有两种实现方式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createProxyMiddleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-proxy-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置允许跨域访问该服务.</span>
app<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
   <span class="token comment">// 设置是否运行客户端设置 withCredentials</span>
   <span class="token comment">// 即在不同域名下发出的请求也可以携带 cookie</span>
   <span class="token comment">// res.header(&quot;Access-Control-Allow-Credentials&quot;, true)</span>
   <span class="token comment">// 第二个参数表示允许跨域的域名，* 代表所有域名</span>
   res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
   res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'GET, PUT, POST, OPTIONS'</span><span class="token punctuation">)</span> <span class="token comment">// 允许的 http 请求的方法</span>
   <span class="token comment">// 允许前台获得的除 Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma 这几张基本响应头之外的响应头</span>
   res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'Content-Type, Authorization, Content-Length, X-Requested-With'</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> targetUrl <span class="token operator">=</span> <span class="token string">&quot;http://localhost:9001&quot;</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/*'</span><span class="token punctuation">,</span> <span class="token function">createProxyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> target<span class="token operator">:</span> targetUrl<span class="token punctuation">,</span> changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//配置服务端口</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">localhost:4000</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token comment">// 第一步：接受客户端请求</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 代理服务器，直接和浏览器直接交互，需要设置CORS 的首部字段</span>
  response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
    <span class="token string">'Access-Control-Allow-Methods'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
    <span class="token string">'Access-Control-Allow-Headers'</span><span class="token operator">:</span> <span class="token string">'Content-Type'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 第二步：将请求转发给服务器</span>
  <span class="token keyword">const</span> proxyRequest <span class="token operator">=</span> http
    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">9001</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        method<span class="token operator">:</span> request<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
        headers<span class="token operator">:</span> request<span class="token punctuation">.</span>headers
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token parameter">serverResponse</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 第三步：收到服务器的响应</span>
        <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
        serverResponse<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          body <span class="token operator">+=</span> chunk
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        serverResponse<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 第四步：将响应结果转发给浏览器</span>
          response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The proxyServer is running at http://localhost:4000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>第三步， 模拟服务器 <code>9001</code> 端口数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 服务端</span>
<span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/getData'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'a'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9001</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>直接从 <code>3000</code> 请求 <code>9001</code> 的数据是跨域的，不允许的，但是通过 <code>node</code> 中间件之后，数据就可以互通，实现了跨域</p> <h4 id="解释"><a href="#解释" class="header-anchor">#</a> 解释</h4> <p><code>http://localhost:9001</code> 目标服务器，没有设置跨域，如果在客户端直接请求 <code>9001</code> 端口就会报跨域错误。</p> <p><code>http://localhost:4000</code> <code>node</code> 中间件，因为设置了跨域，所以可以接收 <code>3000</code> 的请求，把 <code>3000</code> 的请求转发到 <code>9001</code> 服务器，<code>9001</code> 服务器返回数据到 <code>4000</code>，<code>4000</code> 在返回给 <code>3000</code>，就解决了跨域问题。</p> <p>http://localhost:<code>3000</code>  客户端</p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <ul><li><code>CORS</code> 支持所有类型的 <code>HTTP</code> 请求，是跨域 <code>HTTP</code> 请求的根本解决方案</li> <li><code>JSONP</code> 只支持 <code>GET</code> 请求，<code>JSONP</code> 的优势在于支持老式浏览器，以及可以向不支持 <code>CORS</code> 的网站请求数据。</li> <li>不管是 <code>Node</code> 中间件代理还是 <code>nginx</code> 反向代理，主要是通过同源策略对服务器不加限制。</li> <li>日常工作中，用得比较多的跨域方案是 <code>CORS</code> 和 <code>nginx</code> 反向代理</li></ul></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Underglaze-Blue/blog/edit/master/docs/01.js/02.JS相关内容/08.跨域及解决方案.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/blog/tags/?tag=JS" title="标签">#JS</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/03/25 20:47:33</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/blog/pages/4341c8/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">连续赋值</div></a> <a href="/blog/pages/af9354/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">节流和防抖</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/pages/4341c8/" class="prev">连续赋值</a></span> <span class="next"><a href="/blog/pages/af9354/">节流和防抖</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/pages/b4f229/"><div>a标签下载限制</div></a> <span>08-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/pages/1837f4/"><div>必应每日一图</div></a> <span>05-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/pages/3650ca/"><div>小球碰壁反弹动画</div></a> <span>05-26</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://xiaokui.xin" title="链接" target="_blank" class="iconfont icon-link"></a><a href="https://github.com/Underglaze-Blue" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=143171810" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>Himawari | <a href="https://github.com/Underglaze-Blue/blog/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <div class="body-bg" style="background:url('https://cdn.jsdelivr.net/gh/Underglaze-Blue/git-img@main/2023-04-12/3%20(1)-1829-1830.png') rgba(0,0,0,0.1) center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b8aeef37.js" defer></script><script src="/blog/assets/js/2.a4763320.js" defer></script><script src="/blog/assets/js/3.45fe7a32.js" defer></script><script src="/blog/assets/js/14.40872037.js" defer></script>
  </body>
</html>